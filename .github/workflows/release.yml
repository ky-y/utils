name: Publish Package

on:
    repository_dispatch:
        types: [ release-command ]
    workflow_dispatch:
        inputs:
            verUpType:
                description: "Version-Up Type"
                required: true
                type: choice
                options:
                    - "patch"
                    - "minor"
                    - "major"

jobs:
    validation:
        runs-on: ubuntu-latest
        if: ${{ !contains(fromJSON('["patch", "minor", "major"]'), (github.event.client_payload.slash_command.args.unnamed.arg1 || github.event.inputs.verUpType)) }}
        steps:

            -   name: Failed Report
                if: ${{ github.event.inputs.verUpType == '' }}
                uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043
                with:
                    token: ${{ secrets.PAT }}
                    repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
                    issue-number: ${{ github.event.client_payload.github.payload.issue.number }}
                    body: |
                        From Release Bot
                        
                        The /release command requires one of major, minor, or patch.
                        
                        ```
                        /release major
                        /release minor
                        /release patch
                        ```

            -   name: Exit 2
                run: exit 2
    

    publish:
        runs-on: ubuntu-latest
        if: ${{ ! failure() }}
        needs:
            validation
        permissions:
            id-token: write
        steps:
            -   uses: actions/checkout@v4

            -   uses: actions/setup-node@v4
                with:
                    node-version: '22.x'
                    registry-url: 'https://registry.npmjs.org'

            -   name: Cache Dependencies
                id: npm_cache
                uses: actions/cache@v4
                with:
                    path: '**/node_modules'
                    key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}

            -   name: Install Dependencies
                if: steps.yarn_cache.outputs.cache-hit != 'true'
                run: yarn install

            -   name: Get Version-Up Type
                id: ver_up_type
                run: |
                    VER_UP_TYPE=${{ github.event.client_payload.slash_command.args.unnamed.arg1 || github.event.inputs.verUpType }}
                    echo "VER_UP_TYPE=$VER_UP_TYPE" >> $GITHUB_OUTPUT


            -   name: Publish Package to npmjs
                run: |
                    git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
                    git config --local user.name "github-actions[bot]"
                    npm version `npm view @ky-y./utils version` --allow-same-version
                    npm version ${{ steps.ver_up_type.outputs.VER_UP_TYPE }}
                    npm publish --provenance
                env:
                    NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}